<script>
    const tg = window.Telegram.WebApp;

    const presetsContainer = document.getElementById('presets-container');
    const messageArea = document.getElementById('message-area');

    function populatePresets(presets) {
        presetsContainer.innerHTML = '';

        if (!presets || presets.length === 0) {
            messageArea.textContent = 'You have no saved news presets. You can create them using the "My Saved News 📝" button in the bot.';
            return;
        }

        messageArea.style.display = 'none';

        presets.forEach(preset => {
            const presetButton = document.createElement('div');
            presetButton.className = 'preset-item';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = preset.name;
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'news-type';
            typeSpan.textContent = preset.news_type;

            presetButton.appendChild(nameSpan);
            presetButton.appendChild(typeSpan);

            presetButton.addEventListener('click', () => {
                const messages = JSON.parse(preset.serialized_messages);
                const stickerPart = messages.find(m => m.sticker);
                const textPart = messages.find(m => m.text || m.caption);
                
                const submissionData = {
                    newsType: preset.news_type,
                    stickerFileId: stickerPart ? stickerPart.sticker : null, // Corrected line
                    text: textPart ? (textPart.text || textPart.caption) : '',
                    enableAnonReply: preset.anonymous_replies_enabled === 1
                };
                
                tg.showConfirm(`Submit the preset "${preset.name}"?`, (isConfirmed) => {
                    if (isConfirmed) {
                        tg.sendData(JSON.stringify(submissionData));
                        // The app will close after sending data
                    }
                });
            });

            presetsContainer.appendChild(presetButton);
        });
    }

    tg.ready(() => {
        tg.expand();
        try {
            // Get data passed in the URL (e.g., ?data=....)
            const urlParams = new URLSearchParams(window.location.search);
            const dataB64 = urlParams.get('data');

            if (dataB64) {
                // Decode the data from Base64 and parse the JSON
                const presetsJson = atob(dataB64);
                const presets = JSON.parse(presetsJson);
                populatePresets(presets);
            } else {
                messageArea.textContent = 'Could not load data. Please open the app using the /presets command in the bot.';
            }
        } catch (e) {
            tg.showAlert(`Error processing initial data: ${e}`);
            messageArea.textContent = 'There was an error loading your presets.';
        }
    });
</script>
