<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cinder App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {--tg-bg: var(--tg-theme-bg-color, #ffffff);--tg-text: var(--tg-theme-text-color, #000000);--tg-hint: var(--tg-theme-hint-color, #999999);--tg-button: var(--tg-theme-button-color, #007aff);--tg-button-text: var(--tg-theme-button-text-color, #ffffff);--tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);--tg-header-bg: var(--tg-theme-header-bg-color, #efeff3);}
        @keyframes fadeInUp {from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); }}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;background-color: var(--tg-bg);color: var(--tg-text);margin: 0;padding: 0;display: flex;flex-direction: column;height: 100vh;overflow: hidden;-webkit-font-smoothing: antialiased;}
        .main-content {flex-grow: 1; overflow-y: auto; padding: 20px 20px 80px 20px;}
        .page { display: none; animation: fadeInUp 0.5s ease-out forwards; }
        .page.active { display: block; }
        h2 { font-size: 28px; font-weight: 700; margin: 0 0 25px 0; }
        .tab-bar {display: flex; justify-content: space-around; background-color: var(--tg-secondary-bg); border-top: 1px solid var(--tg-hint-color, #e0e0e0); position: fixed; bottom: 0; width: 100%; box-sizing: border-box; padding-bottom: env(safe-area-inset-bottom, 0);}
        .tab-item {flex-grow: 1; text-align: center; padding: 12px 0; cursor: pointer; color: var(--tg-hint); transition: color 0.2s ease;}
        .tab-item svg { width: 28px; height: 28px; fill: currentColor; }
        .tab-item.active { color: var(--tg-button); }
        .form-section { margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-button { padding: 15px; border-radius: 12px; background-color: var(--tg-secondary-bg); border: 2px solid transparent; text-align: center; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .form-button:active { transform: scale(0.97); }
        .form-button.active { border-color: var(--tg-button); background-color: transparent; }
        textarea {width: 100%; height: 120px; padding: 12px; border-radius: 12px; border: 1px solid var(--tg-secondary-bg); background-color: var(--tg-secondary-bg); color: var(--tg-text); font-size: 16px; resize: none; box-sizing: border-box;}
        textarea:focus { background-color: transparent; border-color: var(--tg-button); outline: none; }
        .sticker-button-wrapper { display: flex; align-items: center; gap: 10px; }
        .sticker-button-wrapper .form-button { flex-grow: 1; }
        .sticker-button-wrapper img { height: 53px; width: 53px; border-radius: 8px; background-color: var(--tg-secondary-bg); object-fit: cover; }
        .option-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; font-size: 15px; }
        .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--tg-secondary-bg); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 23px; width: 23px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--tg-button); }
        input:checked + .slider:before { transform: translateX(20px); }
        .preview-container { margin-top: 25px; padding: 15px; background-color: var(--tg-secondary-bg); border-radius: 12px; }
        .preview-container h3 { margin: 0 0 10px 0; font-size: 14px; color: var(--tg-hint); font-weight: 600; }
        .preview-content { display: flex; gap: 10px; }
        .preview-sticker img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .preview-text-content { flex-grow: 1; font-size: 15px; white-space: pre-wrap; word-wrap: break-word; }
        .preview-border { margin-top: 10px; font-size: 12px; color: var(--tg-hint); white-space: pre-wrap; text-align: center; }
        .debug-button { background-color: var(--tg-hint); color: var(--tg-bg); margin-top: 10px; padding: 8px; font-size: 12px; border-radius: 8px; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="main-content">
        <div id="page-submit" class="page"><h2>New Submission</h2><div class="form-section grid-2"><div class="form-button" id="type-ordinary">Ordinary üå™</div><div class="form-button" id="type-sinners">Sinners ‚õì</div></div><div class="form-section sticker-button-wrapper"><div class="form-button" id="sticker-selector">Select Sticker</div><img id="sticker-preview-thumb" src="" style="display: none;"></div><div class="form-section"><textarea id="news-text" placeholder="Write your news text here..."></textarea></div><div class="form-section preview-container" id="live-preview" style="display: none;"><h3>Live Preview</h3><div class="preview-content"><div class="preview-sticker"><img id="preview-sticker-img" src=""></div><div class="preview-text-content"><span id="preview-text"></span></div></div><div class="preview-border" id="preview-border"></div></div><div class="option-item"><span>Enable Anonymous Replies</span><label class="toggle-switch"><input type="checkbox" id="anon-reply-checkbox"><span class="slider"></span></label></div><button id="debug-btn" class="debug-button">Debug Info</button></div>
        <div id="page-shop" class="page"><h2>üõçÔ∏è Shop</h2><p style="text-align: center; color: var(--tg-hint);">The graphical shop for borders and pins will be built here.</p></div>
        <div id="page-profile" class="page"><h2>üë§ My Profile</h2><p style="text-align: center; color: var(--tg-hint);">Your stats, achievements, and rank dashboard will appear here.</p></div>
    </div>
    <nav class="tab-bar"><div class="tab-item" data-page="page-submit"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg></div><div class="tab-item" data-page="page-shop"><svg viewBox="0 0 24 24"><path d="M18 6h-2c0-2.21-1.79-4-4-4S8 3.79 8 6H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-6-2c1.1 0 2 .9 2 2h-4c0-1.1.9-2 2-2zm6 16H6V8h2v2c0 .55.45 1 1 1s1-.45 1-1V8h4v2c0 .55.45 1 1 1s1-.45 1-1V8h2v12z"></path></svg></div><div class="tab-item" data-page="page-profile"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg></div></nav>

<script>
    const tg = window.Telegram.WebApp;

    // --- DOM Elements ---
    const tabItems = document.querySelectorAll('.tab-item');
    const pages = document.querySelectorAll('.page');
    const btnOrdinary = document.getElementById('type-ordinary');
    const btnSinners = document.getElementById('type-sinners');
    const stickerSelector = document.getElementById('sticker-selector');
    const stickerPreviewThumb = document.getElementById('sticker-preview-thumb');
    const newsText = document.getElementById('news-text');
    const anonReplyCheckbox = document.getElementById('anon-reply-checkbox');
    const livePreview = document.getElementById('live-preview');
    const previewStickerImg = document.getElementById('preview-sticker-img');
    const previewText = document.getElementById('preview-text');
    const previewBorder = document.getElementById('preview-border');
    const debugBtn = document.getElementById('debug-btn');
    
    // --- State and Constants ---
    const BORDERS = { ordinary: "‚îÑ ‚îÄ‚îÄ‚îÄ‚ïå ‚ü° ‚ïå‚îÄ‚îÄ‚îÄ ‚îÑ\nëëç CinderNews.t.me .", sinners: "‚ü£‚ïå‚îÄ‚îÄ‚îÄ ‚îÑ ‚îÄ‚îÄ‚îÄ‚ïå‚ü¢\nëëç CinderNews.t.me ." };
    let submissionData = { newsType: null, stickerUrl: null, stickerFileId: null, text: '', enableAnonReply: false };

    // --- Core Functions ---
    function showPage(pageId) {
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        tabItems.forEach(t => t.classList.toggle('active', t.dataset.page === pageId));
        if (pageId === 'page-submit') {
            checkFormCompletion();
        } else {
            tg.MainButton.hide();
        }
    }

    function updatePreview() {
        let shouldShow = false;
        if (submissionData.stickerUrl) {
            previewStickerImg.src = submissionData.stickerUrl;
            shouldShow = true;
        } else {
            previewStickerImg.src = "";
        }
        
        previewText.innerText = submissionData.text || "";
        if (submissionData.text) {
            shouldShow = true;
        }

        if (submissionData.newsType === 'Ordinary üå™') {
            previewBorder.innerText = BORDERS.ordinary;
        } else if (submissionData.newsType === 'Sinners ‚õì') {
            previewBorder.innerText = BORDERS.sinners;
        } else {
            previewBorder.innerText = "";
        }
        
        livePreview.style.display = shouldShow ? 'block' : 'none';
    }

    function checkFormCompletion() {
        if (submissionData.newsType && submissionData.stickerFileId && submissionData.text.trim() !== "") {
            tg.MainButton.show();
        } else {
            tg.MainButton.hide();
        }
    }

    // --- THIS IS THE CORRECTED FUNCTION ---
    function handleStickerSelected(eventData) {
        // This line handles both the new {sticker: ...} format and the old direct format.
        const sticker = eventData.sticker || eventData;

        // A safety check to ensure we have valid sticker data.
        if (!sticker || !sticker.file_id) {
            console.error('Invalid sticker data received:', eventData);
            tg.showAlert('Could not process the selected sticker. Please try again.');
            return;
        }

        submissionData.stickerFileId = sticker.file_id;
        submissionData.stickerUrl = sticker.thumbnail_url;
        stickerPreviewThumb.src = sticker.thumbnail_url;
        stickerPreviewThumb.style.display = 'block';
        checkFormCompletion();
        updatePreview();
    }

    // --- Initialization and Event Listeners ---
    tg.ready();
    
    tg.MainButton.setText('Submit News');
    
    tabItems.forEach(tab => tab.addEventListener('click', () => showPage(tab.dataset.page)));

    btnOrdinary.addEventListener('click', () => {
        submissionData.newsType = 'Ordinary üå™';
        btnOrdinary.classList.add('active');
        btnSinners.classList.remove('active');
        checkFormCompletion();
        updatePreview();
    });

    btnSinners.addEventListener('click', () => {
        submissionData.newsType = 'Sinners ‚õì';
        btnSinners.classList.add('active');
        btnOrdinary.classList.remove('active');
        checkFormCompletion();
        updatePreview();
    });

    newsText.addEventListener('input', (e) => {
        submissionData.text = e.target.value;
        checkFormCompletion();
        updatePreview();
    });

    anonReplyCheckbox.addEventListener('change', (e) => {
        submissionData.enableAnonReply = e.target.checked;
    });

    stickerSelector.addEventListener('click', () => {
        if (tg.openStickerPicker) {
            // New method: relies on the 'stickerSelected' event
            tg.openStickerPicker();
        } else if (tg.showStickerPicker) {
            // Old method: uses a direct callback (kept for compatibility)
            tg.showStickerPicker({ text: 'Select a sticker' }, handleStickerSelected);
        } else {
            tg.showAlert('Your version of Telegram does not support the sticker picker. Please update your app.');
        }
    });

debugBtn.addEventListener('click', () => {
    const debugInfo = [
        `Platform: ${tg.platform}`,
        `App Version: ${tg.version}`,
        // This checks if the client is at least version 7.0, a requirement for many new features.
        `Is Version 7.0+?: ${tg.isVersionAtLeast('7.0')}`,
        `Sticker Picker Available?: ${!!tg.openStickerPicker}`
    ];
    tg.showAlert(debugInfo.join('\n'));
});

    // --- Telegram WebApp SDK Event Handlers ---
    tg.onEvent('stickerSelected', handleStickerSelected);
    
    tg.onEvent('mainButtonClicked', () => {
        if (document.getElementById('page-submit').classList.contains('active')) {
            tg.sendData(JSON.stringify(submissionData));
            tg.close();
        }
    });
    
    // --- Final Setup ---
    tg.expand();
    showPage('page-submit');
    updatePreview();

</script>
</body>
</html>
