<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cinder App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {--tg-bg: var(--tg-theme-bg-color, #ffffff);--tg-text: var(--tg-theme-text-color, #000000);--tg-hint: var(--tg-theme-hint-color, #999999);--tg-button: var(--tg-theme-button-color, #007aff);--tg-button-text: var(--tg-theme-button-text-color, #ffffff);--tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);--tg-header-bg: var(--tg-theme-header-bg-color, #efeff3);}
        @keyframes fadeInUp {from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); }}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;background-color: var(--tg-bg);color: var(--tg-text);margin: 0;padding: 0;display: flex;flex-direction: column;height: 100vh;overflow: hidden;-webkit-font-smoothing: antialiased;}
        .main-content {flex-grow: 1; overflow-y: auto; padding: 20px 20px 80px 20px;}
        .page { display: none; animation: fadeInUp 0.5s ease-out forwards; }
        .page.active { display: block; }
        h2 { font-size: 28px; font-weight: 700; margin: 0 0 25px 0; }
        .tab-bar {display: flex; justify-content: space-around; background-color: var(--tg-secondary-bg); border-top: 1px solid var(--tg-hint-color, #e0e0e0); position: fixed; bottom: 0; width: 100%; box-sizing: border-box; padding-bottom: env(safe-area-inset-bottom, 0);}
        .tab-item {flex-grow: 1; text-align: center; padding: 12px 0; cursor: pointer; color: var(--tg-hint); transition: color 0.2s ease;}
        .tab-item svg { width: 28px; height: 28px; fill: currentColor; }
        .tab-item.active { color: var(--tg-button); }
        .preset-list { display: flex; flex-direction: column; gap: 10px; }
        .preset-item { padding: 15px 20px; border-radius: 12px; background-color: var(--tg-secondary-bg); border: 2px solid transparent; text-align: left; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; }
        .preset-item:active { transform: scale(0.98); }
        .preset-item span { flex-grow: 1; }
        .preset-item .news-type { font-size: 12px; color: var(--tg-hint); margin-left: 10px; }
        #no-presets-message { color: var(--tg-hint); text-align: center; padding: 40px 0; }
    </style>
</head>
<body>
    <div class="main-content">
        <div id="page-submit" class="page">
            <h2>My Saved News</h2>
            <div class="preset-list" id="presets-container">
                </div>
            <p id="no-presets-message" style="display: none;">You have no saved news presets. You can create them using the "My Saved News üìù" button in the bot.</p>
        </div>
        <div id="page-shop" class="page"><h2>üõçÔ∏è Shop</h2><p style="text-align: center; color: var(--tg-hint);">The graphical shop for borders and pins will be built here.</p></div>
        <div id="page-profile" class="page"><h2>üë§ My Profile</h2><p style="text-align: center; color: var(--tg-hint);">Your stats, achievements, and rank dashboard will appear here.</p></div>
    </div>
    <nav class="tab-bar"><div class="tab-item" data-page="page-submit"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg></div><div class="tab-item" data-page="page-shop"><svg viewBox="0 0 24 24"><path d="M18 6h-2c0-2.21-1.79-4-4-4S8 3.79 8 6H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-6-2c1.1 0 2 .9 2 2h-4c0-1.1.9-2 2-2zm6 16H6V8h2v2c0 .55.45 1 1 1s1-.45 1-1V8h4v2c0 .55.45 1 1 1s1-.45 1-1V8h2v12z"></path></svg></div><div class="tab-item" data-page="page-profile"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg></div></nav>

<script>
    const tg = window.Telegram.WebApp;

    // --- DOM Elements ---
    const tabItems = document.querySelectorAll('.tab-item');
    const pages = document.querySelectorAll('.page');
    const presetsContainer = document.getElementById('presets-container');
    const noPresetsMessage = document.getElementById('no-presets-message');

    // --- Core Functions ---
    function showPage(pageId) {
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        tabItems.forEach(t => t.classList.toggle('active', t.dataset.page === pageId));
    }

    function populatePresets(presets) {
        // Clear any existing presets
        presetsContainer.innerHTML = '';

        if (!presets || presets.length === 0) {
            noPresetsMessage.style.display = 'block';
            return;
        }

        noPresetsMessage.style.display = 'none';

        presets.forEach(preset => {
            const presetButton = document.createElement('div');
            presetButton.className = 'preset-item';
            
            // The main name of the preset
            const nameSpan = document.createElement('span');
            nameSpan.textContent = preset.name;
            
            // The news type (Ordinary/Sinners)
            const typeSpan = document.createElement('span');
            typeSpan.className = 'news-type';
            typeSpan.textContent = preset.news_type;

            presetButton.appendChild(nameSpan);
            presetButton.appendChild(typeSpan);

            // Add a click listener to handle submission
            presetButton.addEventListener('click', () => {
                // When a preset is clicked, we send its data to the backend
                // The backend will then forward it to the admin
                
                // First, deserialize the message parts
                const messages = JSON.parse(preset.serialized_messages);
                const stickerPart = messages.find(m => m.sticker);
                const textPart = messages.find(m => m.text || m.caption);
                
                // Construct the data payload expected by the original handle_mini_app_data
                const submissionData = {
                    newsType: preset.news_type,
                    stickerFileId: stickerPart ? stickerPart.sticker : null,
                    text: textPart ? (textPart.text || textPart.caption) : '',
                    enableAnonReply: preset.anonymous_replies_enabled === 1
                };
                
                tg.showConfirm(`Submit the preset "${preset.name}"?`, (isConfirmed) => {
                    if (isConfirmed) {
                        tg.sendData(JSON.stringify(submissionData));
                        tg.close();
                    }
                });
            });

            presetsContainer.appendChild(presetButton);
        });
    }

    // --- Initialization and Event Listeners ---
    tg.ready();

    // 1. Request presets from the backend as soon as the app is ready
    tg.sendData(JSON.stringify({ event: 'get_presets' }));

    // 2. Listen for the backend's response
    tg.onEvent('web_app_data_received', (data) => {
        try {
            // The data from answerWebAppQuery is a string, so we parse it
            const response = JSON.parse(data.data);
            if (response.presets) {
                // If we received presets, populate the UI
                populatePresets(response.presets);
            }
        } catch (e) {
            console.error('Failed to parse presets data:', e);
            tg.showAlert('An error occurred while loading your presets.');
        }
    });

    tabItems.forEach(tab => tab.addEventListener('click', () => showPage(tab.dataset.page)));
    
    // --- Final Setup ---
    tg.expand();
    showPage('page-submit'); // Show the presets page by default
</script>
</body>
</html>
