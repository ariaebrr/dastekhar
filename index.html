<script>
    const tg = window.Telegram.WebApp;

    // This global variable will hold the presets after the app loads.
    let appData = {};

    // --- Your UI Functions ---
    function showMainMenu() {
        document.body.innerHTML = `
            <h1>Cinder News App</h1>
            <p>Welcome! Please choose an option.</p>
            <button class="link-button" onclick="showSubmitNewsView()">Submit News</button>
            <button class="link-button" onclick="alert('Shop not implemented yet')">Shop</button>
            <button class="link-button" onclick="alert('Profile not implemented yet')">My Profile</button>
        `;
    }

    function showSubmitNewsView() {
        document.body.innerHTML = `
            <h2>Submit News</h2>
            <button class="action-button" id="loadPresetsBtn">Load From Saved News</button>
            <div id="presets-container"></div>
            <p id="message-area"></p>
            <hr>
            <button class="link-button" onclick="showMainMenu()">Back to Main Menu</button>
        `;

        // When "Load Presets" is clicked, use the data we already have.
        document.getElementById('loadPresetsBtn').addEventListener('click', () => {
            populatePresets(appData.presets);
        });
    }

    function populatePresets(presets) {
        const presetsContainer = document.getElementById('presets-container');
        const messageArea = document.getElementById('message-area');
        presetsContainer.innerHTML = '';

        if (!presets || presets.length === 0) {
            messageArea.textContent = 'You have no saved news presets.';
            return;
        }
        messageArea.style.display = 'none';

        presets.forEach(preset => {
            const presetButton = document.createElement('div');
            presetButton.className = 'preset-item'; // Use your existing styles
            presetButton.textContent = `${preset.name} (${preset.news_type})`;
            presetButton.style.cursor = 'pointer';

            presetButton.addEventListener('click', () => {
                // This logic for sending data back to the bot remains the same
                // ... (your existing preset submission logic) ...
                tg.showConfirm(`Submit "${preset.name}"?`, (ok) => {
                    if (ok) {
                        // Example of sending data back... adjust as needed
                        tg.sendData(JSON.stringify({ "event": "use_preset", "preset_id": preset.preset_id }));
                    }
                });
            });
            presetsContainer.appendChild(presetButton);
        });
    }

    // --- Main App Startup Logic ---
    tg.ready(() => {
        tg.expand();
        try {
            // Check if the bot passed data in the launch URL
            if (tg.initDataUnsafe.start_param) {
                const dataB64 = tg.initDataUnsafe.start_param;
                const dataJson = atob(dataB64);
                appData = JSON.parse(dataJson); // Save the data for later use
            }
        } catch (e) {
            tg.showAlert(`Error loading initial data: ${e}`);
        }

        // Always show the main menu when the app first opens
        showMainMenu();
    });
</script>
